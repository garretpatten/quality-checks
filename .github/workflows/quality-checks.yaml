name: Quality Checks

on:
  workflow_call:
    inputs:
      actionlint_run:
        description: "Boolean flag indicating whether the actionlint linter should be executed."
        required: false
        default: true
        type: boolean
      eslint_run:
        description: "Boolean flag indicating whether the eslint linter should be executed."
        required: false
        default: true
        type: boolean
      hadolint_run:
        description: "Boolean flag indicating whether the hadolint linter should be executed."
        required: false
        default: true
        type: boolean
      jq_run:
        description: "Boolean flag indicating whether the jq JSON validator should be executed."
        required: false
        default: true
        type: boolean
      markdownlint_run:
        description: "Boolean flag indicating whether the markdownlint-cli2 linter should be executed."
        required: false
        default: true
        type: boolean
      prettier_run:
        description: "Boolean flag indicating whether the Prettier formatting check should be executed."
        required: false
        default: true
        type: boolean
      ruff_run:
        description: "Boolean flag indicating whether the ruff linter should be executed."
        required: false
        default: true
        type: boolean
      shellcheck_run:
        description: "Boolean flag indicating whether the shellcheck linter should be executed."
        required: false
        default: true
        type: boolean
      taplo_run:
        description: "Boolean flag indicating whether the taplo linter should be executed."
        required: false
        default: true
        type: boolean
      yamllint_run:
        description: "Boolean flag indicating whether the yamllint linter should be executed."
        required: false
        default: true
        type: boolean

jobs:
  actionlint:
    if: ${{ inputs.actionlint_run == true }}
    name: "Actionlint - GitHub Actions Linter"
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout Code"
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          fetch-depth: 0

      - name: "Install actionlint"
        run: |
          VERSION=$(curl -s https://api.github.com/repos/rhysd/actionlint/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          curl -sSfL "https://github.com/rhysd/actionlint/releases/download/${VERSION}/actionlint_${VERSION#v}_linux_amd64.tar.gz" -o actionlint.tar.gz
          tar -xzf actionlint.tar.gz
          sudo mv actionlint /usr/local/bin/
          rm actionlint.tar.gz

      - name: "Get changed GitHub Actions files"
        id: changed-files
        run: |
          git fetch origin main master 2>/dev/null || true
          if git show-ref --verify --quiet refs/remotes/origin/main; then
            BASE_REF="origin/main"
          elif git show-ref --verify --quiet refs/remotes/origin/master; then
            BASE_REF="origin/master"
          else
            BASE_REF="HEAD~1"
          fi
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR "$BASE_REF"...HEAD | grep -E '\.(yml|yaml)$' | grep -E '\.github/(workflows|actions)' || true)
          if [ -n "$CHANGED_FILES" ]; then
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "any_changed=true" >> $GITHUB_OUTPUT
          else
            echo "any_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: "Run actionlint"
        run: |
          set -e
          if [ "${{ steps.changed-files.outputs.any_changed }}" == "true" ]; then
            echo "${{ steps.changed-files.outputs.files }}" | while read -r file; do
              if [ -n "$file" ]; then
                actionlint "$file"
              fi
            done
          else
            echo "No GitHub Actions files to check"
          fi

  eslint:
    if: ${{ inputs.eslint_run == true }}
    name: "ESLint - JavaScript/TypeScript Linter"
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout Code"
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          fetch-depth: 0

      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: "Install dependencies"
        run: |
          if [ -f package.json ]; then
            npm ci
          else
            echo "No package.json found, skipping dependency installation"
          fi

      - name: "Install ESLint"
        run: npm install -g eslint

      - name: "Get changed JavaScript/TypeScript files"
        id: changed-files
        run: |
          git fetch origin main master 2>/dev/null || true
          if git show-ref --verify --quiet refs/remotes/origin/main; then
            BASE_REF="origin/main"
          elif git show-ref --verify --quiet refs/remotes/origin/master; then
            BASE_REF="origin/master"
          else
            BASE_REF="HEAD~1"
          fi
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR "$BASE_REF"...HEAD | grep -E '\.(js|jsx|ts|tsx)$' || true)
          if [ -n "$CHANGED_FILES" ]; then
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "any_changed=true" >> $GITHUB_OUTPUT
          else
            echo "any_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: "Run ESLint"
        run: |
          set -e
          if [ "${{ steps.changed-files.outputs.any_changed }}" == "true" ]; then
            echo "${{ steps.changed-files.outputs.files }}" | while read -r file; do
              if [ -n "$file" ]; then
                npx eslint "$file"
              fi
            done
          else
            echo "No JavaScript/TypeScript files to check"
          fi

  hadolint:
    if: ${{ inputs.hadolint_run == true }}
    name: "Hadolint - Dockerfile Linter"
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout Code"
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          fetch-depth: 0

      - name: "Install Hadolint"
        run: |
          curl -sSfL https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64 -o hadolint
          chmod +x hadolint
          sudo mv hadolint /usr/local/bin/

      - name: "Get changed Dockerfile files"
        id: changed-files
        run: |
          git fetch origin main master 2>/dev/null || true
          if git show-ref --verify --quiet refs/remotes/origin/main; then
            BASE_REF="origin/main"
          elif git show-ref --verify --quiet refs/remotes/origin/master; then
            BASE_REF="origin/master"
          else
            BASE_REF="HEAD~1"
          fi
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR "$BASE_REF"...HEAD | grep -iE '(Dockerfile|\.dockerfile)' || true)
          if [ -n "$CHANGED_FILES" ]; then
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "any_changed=true" >> $GITHUB_OUTPUT
          else
            echo "any_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: "Run Hadolint"
        run: |
          set -e
          if [ "${{ steps.changed-files.outputs.any_changed }}" == "true" ]; then
            echo "${{ steps.changed-files.outputs.files }}" | while read -r file; do
              if [ -n "$file" ]; then
                hadolint "$file"
              fi
            done
          else
            echo "No Dockerfile files to check"
          fi

  jq:
    if: ${{ inputs.jq_run == true }}
    name: "jq - JSON Validator"
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout Code"
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          fetch-depth: 0

      - name: "Install jq"
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: "Get changed JSON files"
        id: changed-files
        run: |
          git fetch origin main master 2>/dev/null || true
          if git show-ref --verify --quiet refs/remotes/origin/main; then
            BASE_REF="origin/main"
          elif git show-ref --verify --quiet refs/remotes/origin/master; then
            BASE_REF="origin/master"
          else
            BASE_REF="HEAD~1"
          fi
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR "$BASE_REF"...HEAD | grep -E '\.json$' || true)
          if [ -n "$CHANGED_FILES" ]; then
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "any_changed=true" >> $GITHUB_OUTPUT
          else
            echo "any_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: "Run jq"
        run: |
          set -e
          if [ "${{ steps.changed-files.outputs.any_changed }}" == "true" ]; then
            echo "${{ steps.changed-files.outputs.files }}" | while read -r file; do
              if [ -n "$file" ]; then
                jq -e . "$file" > /dev/null
              fi
            done
          else
            echo "No JSON files to check"
          fi

  markdownlint:
    if: ${{ inputs.markdownlint_run == true }}
    name: "Markdownlint - Markdown Linter"
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout Code"
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          fetch-depth: 0

      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: "Install markdownlint-cli2"
        run: npm install -g markdownlint-cli2

      - name: "Get changed Markdown files"
        id: changed-files
        run: |
          git fetch origin main master 2>/dev/null || true
          if git show-ref --verify --quiet refs/remotes/origin/main; then
            BASE_REF="origin/main"
          elif git show-ref --verify --quiet refs/remotes/origin/master; then
            BASE_REF="origin/master"
          else
            BASE_REF="HEAD~1"
          fi
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR "$BASE_REF"...HEAD | grep -E '\.(md|markdown)$' || true)
          if [ -n "$CHANGED_FILES" ]; then
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "any_changed=true" >> $GITHUB_OUTPUT
          else
            echo "any_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: "Run markdownlint-cli2"
        run: |
          set -e
          if [ "${{ steps.changed-files.outputs.any_changed }}" == "true" ]; then
            echo "${{ steps.changed-files.outputs.files }}" | while read -r file; do
              if [ -n "$file" ]; then
                markdownlint-cli2 "$file"
              fi
            done
          else
            echo "No Markdown files to check"
          fi

  prettier:
    if: ${{ inputs.prettier_run == true }}
    name: "Prettier - Code Formatter"
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout Code"
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          fetch-depth: 0

      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: "Install Prettier"
        run: npm install -g prettier

      - name: "Get changed files"
        id: changed-files
        run: |
          git fetch origin main master 2>/dev/null || true
          if git show-ref --verify --quiet refs/remotes/origin/main; then
            BASE_REF="origin/main"
          elif git show-ref --verify --quiet refs/remotes/origin/master; then
            BASE_REF="origin/master"
          else
            BASE_REF="HEAD~1"
          fi
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR "$BASE_REF"...HEAD | grep -E '\.(js|jsx|ts|tsx|json|css|scss|md|yml|yaml)$' || true)
          if [ -n "$CHANGED_FILES" ]; then
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "any_changed=true" >> $GITHUB_OUTPUT
          else
            echo "any_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: "Run Prettier"
        run: |
          set -e
          if [ "${{ steps.changed-files.outputs.any_changed }}" == "true" ]; then
            echo "${{ steps.changed-files.outputs.files }}" | while read -r file; do
              if [ -n "$file" ]; then
                prettier --check "$file"
              fi
            done
          else
            echo "No files to check with Prettier"
          fi

  ruff:
    if: ${{ inputs.ruff_run == true }}
    name: "Ruff - Python Linter"
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout Code"
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          fetch-depth: 0

      - name: "Install Ruff"
        run: |
          pip3 install ruff

      - name: "Get changed Python files"
        id: changed-files
        run: |
          git fetch origin main master 2>/dev/null || true
          if git show-ref --verify --quiet refs/remotes/origin/main; then
            BASE_REF="origin/main"
          elif git show-ref --verify --quiet refs/remotes/origin/master; then
            BASE_REF="origin/master"
          else
            BASE_REF="HEAD~1"
          fi
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR "$BASE_REF"...HEAD | grep -E '\.(py|pyw)$' || true)
          if [ -n "$CHANGED_FILES" ]; then
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "any_changed=true" >> $GITHUB_OUTPUT
          else
            echo "any_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: "Run Ruff"
        run: |
          set -e
          if [ "${{ steps.changed-files.outputs.any_changed }}" == "true" ]; then
            echo "${{ steps.changed-files.outputs.files }}" | while read -r file; do
              if [ -n "$file" ]; then
                ruff check "$file"
              fi
            done
          else
            echo "No Python files to check"
          fi

  shellcheck:
    if: ${{ inputs.shellcheck_run == true }}
    name: "ShellCheck - Shell Script Linter"
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout Code"
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          fetch-depth: 0

      - name: "Install ShellCheck"
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: "Get changed shell files"
        id: changed-files
        run: |
          git fetch origin main master 2>/dev/null || true
          if git show-ref --verify --quiet refs/remotes/origin/main; then
            BASE_REF="origin/main"
          elif git show-ref --verify --quiet refs/remotes/origin/master; then
            BASE_REF="origin/master"
          else
            BASE_REF="HEAD~1"
          fi
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR "$BASE_REF"...HEAD | grep -E '\.(sh|bash|zsh)$' || true)
          if [ -n "$CHANGED_FILES" ]; then
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "any_changed=true" >> $GITHUB_OUTPUT
          else
            echo "any_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: "Run ShellCheck"
        run: |
          set -e
          if [ "${{ steps.changed-files.outputs.any_changed }}" == "true" ]; then
            echo "${{ steps.changed-files.outputs.files }}" | while read -r file; do
              if [ -n "$file" ]; then
                shellcheck "$file"
              fi
            done
          else
            echo "No shell files to check"
          fi

  taplo:
    if: ${{ inputs.taplo_run == true }}
    name: "Taplo - TOML Linter"
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout Code"
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          fetch-depth: 0

      - name: "Install Taplo"
        run: |
          curl -L https://github.com/tamasfe/taplo/releases/latest/download/taplo-linux-x86_64.gz -o taplo.gz
          gunzip taplo.gz
          chmod +x taplo
          sudo mv taplo /usr/local/bin/

      - name: "Get changed TOML files"
        id: changed-files
        run: |
          git fetch origin main master 2>/dev/null || true
          if git show-ref --verify --quiet refs/remotes/origin/main; then
            BASE_REF="origin/main"
          elif git show-ref --verify --quiet refs/remotes/origin/master; then
            BASE_REF="origin/master"
          else
            BASE_REF="HEAD~1"
          fi
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR "$BASE_REF"...HEAD | grep -E '\.(toml)$' || true)
          if [ -n "$CHANGED_FILES" ]; then
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "any_changed=true" >> $GITHUB_OUTPUT
          else
            echo "any_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: "Run Taplo"
        run: |
          set -e
          if [ "${{ steps.changed-files.outputs.any_changed }}" == "true" ]; then
            echo "${{ steps.changed-files.outputs.files }}" | while read -r file; do
              if [ -n "$file" ]; then
                taplo lint "$file"
              fi
            done
          else
            echo "No TOML files to check"
          fi

  yamllint:
    if: ${{ inputs.yamllint_run == true }}
    name: "Yamllint - YAML Linter"
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout Code"
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          fetch-depth: 0

      - name: "Install yamllint"
        run: |
          pip3 install yamllint

      - name: "Get changed YAML files"
        id: changed-files
        run: |
          git fetch origin main master 2>/dev/null || true
          if git show-ref --verify --quiet refs/remotes/origin/main; then
            BASE_REF="origin/main"
          elif git show-ref --verify --quiet refs/remotes/origin/master; then
            BASE_REF="origin/master"
          else
            BASE_REF="HEAD~1"
          fi
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR "$BASE_REF"...HEAD | grep -E '\.(yml|yaml)$' || true)
          if [ -n "$CHANGED_FILES" ]; then
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "any_changed=true" >> $GITHUB_OUTPUT
          else
            echo "any_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: "Run yamllint"
        run: |
          set -e
          if [ "${{ steps.changed-files.outputs.any_changed }}" == "true" ]; then
            echo "${{ steps.changed-files.outputs.files }}" | while read -r file; do
              if [ -n "$file" ]; then
                yamllint "$file"
              fi
            done
          else
            echo "No YAML files to check"
          fi
